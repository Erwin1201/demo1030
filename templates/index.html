<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <title>收納式記事本（垂直細項）</title>
    <style>
        body {
            font-family: "Noto Sans TC", sans-serif;
            margin: 0;
            background: #f5f5f5;
        }

        .menu-bar {
            background: #333;
            color: white;
            padding: 10px;
            display: flex;
            justify-content: space-between;
        }

        .menu button {
            margin-right: 10px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .editor {
            padding: 20px;
        }

        /* 單一主項（垂直排列） */
        .line {
            display: flex;
            flex-direction: column;
            margin-bottom: 8px;
        }

        /* 主項的上半段（箭頭 + 輸入欄位） */
        .line-header {
            display: flex;
            align-items: center;
        }

        .line-header button {
            width: 28px;
            height: 28px;
            margin-right: 6px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 18px;
        }

        .line-header input {
            flex: 1;
            padding: 5px 10px;
            font-size: 16px;
            border: 1px solid #ccc;
            border-radius: 6px;
        }

        /* 細項區塊：在下方並縮排 */
        .subitems {
            margin-left: 40px;
            margin-top: 5px;
            display: none;
            flex-direction: column;
        }

        .subitems input {
            display: block;
            margin-top: 4px;
            width: 90%;
            padding: 5px 10px;
            font-size: 15px;
            border: 1px solid #bbb;
            border-radius: 6px;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="menu-bar">
        <div class="menu">
            <button onclick="newFile()">📝 新檔</button>
            <input type="file" id="fileInput" accept=".txt" class="hidden" onchange="openLocalFile(event)">
            <button onclick="document.getElementById('fileInput').click()">📂 開啟舊檔</button>
            <button onclick="saveLocalFile()">💾 另存新檔</button>
        </div>
    </div>

    <div class="editor" id="editor"></div>

    <script>
        const editor = document.getElementById("editor");

        // 初始化：加入第一行
        addNewLine();

        // === 新增一行主項 ===
        function addNewLine(value = "") {
            const lineDiv = document.createElement("div");
            lineDiv.className = "line";

            const header = document.createElement("div");
            header.className = "line-header";

            const toggleBtn = document.createElement("button");
            toggleBtn.textContent = "▶";
            toggleBtn.onclick = function () {
                toggleSubitems(lineDiv);
            };

            const input = document.createElement("input");
            input.type = "text";
            input.value = value;
            input.placeholder = "輸入內容...";
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addNewLineBelow(lineDiv);
                }
            });

            header.appendChild(toggleBtn);
            header.appendChild(input);
            lineDiv.appendChild(header);

            const subDiv = document.createElement("div");
            subDiv.className = "subitems";
            lineDiv.appendChild(subDiv);

            editor.appendChild(lineDiv);
        }

        // === 展開 / 收起細項 ===
        function toggleSubitems(lineDiv) {
            const btn = lineDiv.querySelector(".line-header button");
            const subDiv = lineDiv.querySelector(".subitems");

            if (subDiv.style.display === "flex") {
                subDiv.style.display = "none";
                btn.textContent = "▶";
            } else {
                subDiv.style.display = "flex";
                btn.textContent = "▼";
                if (subDiv.children.length === 0) addSubItem(subDiv);
            }
        }

        // === 新增細項 ===
        function addSubItem(subDiv) {
            const subInput = document.createElement("input");
            subInput.type = "text";
            subInput.placeholder = "補充細項...";
            subInput.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addSubItem(subDiv);
                }
            });
            subDiv.appendChild(subInput);
        }

        // === 在目前行的下方新增新行 ===
        function addNewLineBelow(currentLine) {
            const newLine = document.createElement("div");
            newLine.className = "line";

            const header = document.createElement("div");
            header.className = "line-header";

            const toggleBtn = document.createElement("button");
            toggleBtn.textContent = "▶";
            toggleBtn.onclick = function () {
                toggleSubitems(newLine);
            };

            const input = document.createElement("input");
            input.type = "text";
            input.placeholder = "輸入內容...";
            input.addEventListener("keydown", (e) => {
                if (e.key === "Enter") {
                    e.preventDefault();
                    addNewLineBelow(newLine);
                }
            });

            header.appendChild(toggleBtn);
            header.appendChild(input);
            newLine.appendChild(header);

            const subDiv = document.createElement("div");
            subDiv.className = "subitems";
            newLine.appendChild(subDiv);

            editor.insertBefore(newLine, currentLine.nextSibling);
            input.focus();
        }

        // === 儲存 ===
        function saveLocalFile() {
            let text = "";
            const lines = document.querySelectorAll(".line");

            lines.forEach(line => {
                const mainText = line.querySelector(".line-header input").value;
                text += mainText + "\n";
                const subInputs = line.querySelectorAll(".subitems input");
                subInputs.forEach(sub => {
                    text += "    - " + sub.value + "\n";
                });
            });

            const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            const filename = prompt("請輸入檔名（不需加副檔名）", "新記事本") + ".txt";
            if (filename === "null.txt") return;

            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
            URL.revokeObjectURL(link.href);
        }

        // === 開啟舊檔 ===
        function openLocalFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                loadFromText(e.target.result);
            };
            reader.readAsText(file, "utf-8");
        }

        function loadFromText(text) {
            editor.innerHTML = "";
            const lines = text.split("\n");
            let currentLine = null;

            lines.forEach(line => {
                if (line.startsWith("    - ")) {
                    const subText = line.replace("    - ", "");
                    const subDiv = currentLine.querySelector(".subitems");
                    if (subDiv) {
                        subDiv.style.display = "flex";
                        currentLine.querySelector(".line-header button").textContent = "▼";
                        addSubItem(subDiv);
                        subDiv.lastChild.value = subText;
                    }
                } else if (line.trim() !== "") {
                    addNewLine(line.trim());
                    currentLine = editor.lastChild;
                }
            });
        }

        // === 新檔 ===
        function newFile() {
            editor.innerHTML = "";
            addNewLine();
        }
    </script>
</body>
</html>
